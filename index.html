<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knoxville Restaurants</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            --stone-950: #0c0a09;
            --sienna-400: #f0a27e;
            --sienna-500: #e87f52;
            --sienna-600: #c6613f;
            --orange-200: #fed7aa;
            --orange-500: #f97316;
            --orange-900: #7c2d12;
            --amber-700: #b45309;
            --blue-600: #2563eb;
            --purple-600: #9333ea;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--stone-50);
            color: var(--stone-900);
            line-height: 1.6;
            min-height: 100vh;
        }
        body.dark { background: var(--stone-950); color: var(--stone-100); }

        .container { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        .header {
            flex-shrink: 0;
            background: white;
            border-bottom: 1px solid var(--stone-200);
            padding: 1.25rem 1rem;
        }
        body.dark .header { background: var(--stone-900); border-color: var(--stone-800); }

        .header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; }

        h1 { font-size: 1.5rem; font-weight: 600; color: var(--stone-900); margin-bottom: 0.25rem; }
        body.dark h1 { color: var(--stone-100); }

        .stats { font-size: 0.875rem; color: var(--stone-500); }
        body.dark .stats { color: var(--stone-400); }

        .theme-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--stone-700);
        }
        .theme-btn:hover { background: var(--stone-50); }
        body.dark .theme-btn { background: var(--stone-900); border-color: var(--stone-700); color: var(--stone-300); }
        body.dark .theme-btn:hover { background: var(--stone-800); }

        /* Filters */
        .filters-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .search-wrapper { position: relative; width: 100%; max-width: 28rem; }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            color: var(--stone-400);
        }

        .search-input {
            width: 100%;
            height: 2.75rem;
            padding: 0 1rem 0 2.5rem;
            font-size: 0.875rem;
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 9999px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            outline: none;
            transition: all 0.2s;
            color: var(--stone-900);
        }
        .search-input:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .search-input:focus { border-color: transparent; box-shadow: 0 0 0 2px var(--sienna-400); }
        body.dark .search-input { background: var(--stone-900); border-color: var(--stone-700); color: var(--stone-100); }
        body.dark .search-input:focus { box-shadow: 0 0 0 2px var(--sienna-500); }

        .filter-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .select-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }

        select {
            height: 2.75rem;
            padding: 0 2rem 0 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 0.75rem;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
            color: var(--stone-900);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a8a29e' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }
        select:hover { border-color: var(--sienna-400); }
        body.dark select { background: var(--stone-900); border-color: var(--stone-700); color: var(--stone-100); }

        .quick-filters { display: flex; gap: 0.5rem; align-items: center; }

        .quick-filter {
            height: 2.75rem;
            padding: 0 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            background: white;
            border: 1px solid var(--stone-300);
            border-radius: 9999px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            color: var(--stone-700);
        }
        body.dark .quick-filter { background: var(--stone-900); border-color: var(--stone-700); color: var(--stone-300); }
        .quick-filter.active-new { background: var(--orange-500); color: white; border-color: var(--orange-500); }
        .quick-filter.active-coffee { background: var(--amber-700); color: white; border-color: var(--amber-700); }

        .clear-btn {
            font-size: 0.875rem;
            color: var(--stone-600);
            text-decoration: underline;
            text-underline-offset: 4px;
            cursor: pointer;
            background: none;
            border: none;
        }
        .clear-btn:hover { color: var(--stone-900); }
        body.dark .clear-btn { color: var(--stone-400); }
        body.dark .clear-btn:hover { color: var(--stone-100); }
        .clear-btn.hidden { display: none; }

        /* Main Content */
        .main { flex: 1; overflow-y: auto; padding: 1.5rem; background: white; min-height: 0; }
        body.dark .main { background: var(--stone-900); }

        .loading { display: flex; justify-content: center; align-items: center; height: 24rem; }
        .loading.hidden { display: none; }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 4px solid var(--stone-200);
            border-top-color: var(--sienna-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        table.hidden { display: none; }

        thead {
            border-bottom: 1px solid rgba(12, 10, 9, 0.1);
        }
        body.dark thead { border-bottom-color: rgba(255, 255, 255, 0.1); }

        th {
            text-align: left;
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: var(--stone-700);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        body.dark th { color: var(--stone-400); }
        th:first-child { padding-left: 0.5rem; }
        th:last-child { padding-right: 0.5rem; }

        th button {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0;
            cursor: pointer;
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            transition: color 0.2s;
        }
        th button:hover { color: var(--stone-950); }
        body.dark th button:hover { color: white; }

        tbody tr {
            position: relative;
        }

        tbody tr:nth-child(even) {
            background: rgba(12, 10, 9, 0.025);
        }
        body.dark tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.025); }

        tbody tr:hover {
            background: rgba(12, 10, 9, 0.05);
        }
        body.dark tbody tr:hover { background: rgba(255, 255, 255, 0.05); }

        td {
            position: relative;
            padding: 1rem;
            color: var(--stone-500);
            border-bottom: 1px solid rgba(12, 10, 9, 0.05);
        }
        body.dark td { color: var(--stone-400); border-bottom-color: rgba(255, 255, 255, 0.05); }
        td:first-child { padding-left: 0.5rem; }
        td:last-child { padding-right: 0.5rem; }

        .restaurant-name {
            color: var(--stone-950);
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        .restaurant-name:hover { color: var(--sienna-600); }
        body.dark .restaurant-name { color: white; }
        body.dark .restaurant-name:hover { color: var(--sienna-400); }

        .badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-new { background: var(--orange-200); color: var(--orange-900); }
        .badge-price-1 { background: var(--stone-100); color: var(--stone-700); }
        .badge-price-2 { background: #dbeafe; color: var(--blue-600); }
        .badge-price-3 { background: #fef3c7; color: var(--amber-700); }
        .badge-price-4 { background: #f3e8ff; color: var(--purple-600); }
        body.dark .badge-price-1 { background: var(--stone-800); color: var(--stone-300); }

        .score {
            font-variant-numeric: tabular-nums;
            font-weight: 500;
            color: var(--stone-700);
        }
        body.dark .score { color: var(--stone-300); }

        .tag {
            display: inline-block;
            padding: 0.125rem 0.375rem;
            margin: 0.125rem;
            background: var(--stone-100);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: var(--stone-600);
        }
        body.dark .tag { background: var(--stone-800); color: var(--stone-400); }

        .highlights {
            font-size: 0.75rem;
            color: var(--stone-500);
            margin-top: 0.25rem;
            max-width: 32rem;
        }
        body.dark .highlights { color: var(--stone-400); }

        /* Modal - Catalyst Dialog Style */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
        }
        .modal.active { display: block; }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(12, 10, 9, 0.25);
            display: flex;
            justify-content: center;
            overflow-y: auto;
            width: 100vw;
            padding: 0.5rem 0.5rem;
        }
        body.dark .modal-backdrop { background: rgba(12, 10, 9, 0.5); }
        @media (min-width: 640px) {
            .modal-backdrop { padding: 2rem 1.5rem; }
        }
        @media (min-width: 1024px) {
            .modal-backdrop { padding: 4rem 2rem; }
        }

        .modal-wrapper {
            position: fixed;
            inset: 0;
            overflow-y: auto;
            width: 100vw;
            padding-top: 1.5rem;
        }
        @media (min-width: 640px) {
            .modal-wrapper { padding-top: 0; }
        }

        .modal-grid {
            display: grid;
            grid-template-rows: 1fr auto;
            justify-items: center;
            min-height: 100%;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .modal-grid { grid-template-rows: 1fr auto 3fr; }
        }

        .modal-content {
            grid-row-start: 2;
            width: 100%;
            min-width: 0;
            max-width: 64rem;
            background: white;
            border-radius: 1.5rem 1.5rem 0 0;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(12, 10, 9, 0.1);
        }
        @media (min-width: 640px) {
            .modal-content {
                margin-bottom: auto;
                border-radius: 1rem;
            }
        }
        body.dark .modal-content {
            background: var(--stone-900);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        body.dark .modal-header { border-color: var(--stone-800); }

        .modal-title {
            font-size: 1.875rem;
            font-weight: 300;
            color: var(--stone-900);
            margin-bottom: 0.75rem;
            line-height: 1.2;
        }
        body.dark .modal-title { color: white; }

        .modal-meta {
            font-size: 0.875rem;
            color: var(--stone-600);
            line-height: 1.5;
        }
        body.dark .modal-meta { color: var(--stone-400); }

        .modal-close {
            color: var(--stone-400);
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.75rem;
            line-height: 1;
            padding: 0.25rem;
            transition: color 0.2s;
            flex-shrink: 0;
        }
        .modal-close:hover { color: var(--stone-600); }
        body.dark .modal-close { color: var(--stone-500); }
        body.dark .modal-close:hover { color: var(--stone-200); }

        .modal-body {
            padding: 1.5rem 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }
        .modal-section:last-child { margin-bottom: 0; }

        .modal-section h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--stone-900);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        body.dark .modal-section h3 { color: white; }

        .modal-section p {
            color: var(--stone-700);
            line-height: 1.7;
        }
        body.dark .modal-section p { color: var(--stone-300); }

        .modal-section a {
            color: var(--sienna-600);
            text-decoration: none;
            transition: text-decoration 0.2s;
        }
        .modal-section a:hover { text-decoration: underline; }
        body.dark .modal-section a { color: var(--sienna-400); }

        .modal-actions {
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            border-top: 1px solid var(--stone-200);
        }
        body.dark .modal-actions { border-color: var(--stone-800); }

        .modal-btn {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            background: var(--stone-900);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-btn:hover { background: var(--stone-800); }
        body.dark .modal-btn { background: var(--stone-700); }
        body.dark .modal-btn:hover { background: var(--stone-600); }

        @media (max-width: 640px) {
            .header { padding: 1rem; }
            .main { padding: 1rem; overflow-x: auto; }
            .select-group { width: 100%; }
            select { flex: 1; min-width: 0; }
            table { min-width: 900px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-row">
                <div>
                    <h1>Knoxville Restaurants</h1>
                    <p class="stats" id="stats">Loading...</p>
                </div>
                <button class="theme-btn" onclick="toggleTheme()">Toggle Theme</button>
            </div>

            <div class="filters-wrapper">
                <div class="search-wrapper">
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" id="search" class="search-input" placeholder="Search restaurants...">
                </div>

                <div class="filter-row">
                    <div class="select-group">
                        <select id="cuisine-filter">
                            <option value="">All Cuisines</option>
                        </select>
                        <select id="price-filter">
                            <option value="">All Prices</option>
                            <option value="$">$ (Under $15)</option>
                            <option value="$$">$$ ($15-25)</option>
                            <option value="$$$">$$$ ($25-40)</option>
                            <option value="$$$$">$$$$ ($40+)</option>
                        </select>
                        <select id="neighborhood-filter">
                            <option value="">All Areas</option>
                        </select>
                        <select id="group-filter">
                            <option value="">All Groups</option>
                        </select>
                    </div>

                    <div class="quick-filters">
                        <button id="new-filter" class="quick-filter" onclick="toggleFilter('new')">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            New
                        </button>
                        <button id="coffee-filter" class="quick-filter" onclick="toggleFilter('coffee')">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/></svg>
                        </button>
                        <button id="clear-filters" class="clear-btn hidden" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main">
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>

            <table id="restaurants-table" class="hidden">
                <thead>
                    <tr>
                        <th><button onclick="sortBy('name')">Restaurant <span id="sort-name"></span></button></th>
                        <th><button onclick="sortBy('cuisine_type')">Cuisine <span id="sort-cuisine_type"></span></button></th>
                        <th>Location</th>
                        <th><button onclick="sortBy('price_range')">Price <span id="sort-price_range"></span></button></th>
                        <th><button onclick="sortBy('average_rating')">Rating <span id="sort-average_rating"></span></button></th>
                        <th><button onclick="sortBy('date_night_score')">Date Night <span id="sort-date_night_score"></span></button></th>
                        <th><button onclick="sortBy('atmosphere_score')">Atmosphere <span id="sort-atmosphere_score"></span></button></th>
                        <th><button onclick="sortBy('opening_date')">Opened <span id="sort-opening_date"></span></button></th>
                        <th>Tags</th>
                    </tr>
                </thead>
                <tbody id="restaurants-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-wrapper">
            <div class="modal-grid">
                <div class="modal-content">
                    <div class="modal-header">
                        <div style="flex: 1;">
                            <h2 class="modal-title" id="modal-name"></h2>
                            <p class="modal-meta" id="modal-meta"></p>
                        </div>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body" id="modal-body"></div>
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="restaurants-data.js"></script>
    <script>
        let allRestaurants = [];
        let filteredRestaurants = [];
        let currentSort = { column: 'name', order: 'asc' };

        document.addEventListener('DOMContentLoaded', () => {
            allRestaurants = RESTAURANTS || [];
            populateFilters();
            filterRestaurants();
            setupEventListeners();

            if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
            }
        });

        function setupEventListeners() {
            document.getElementById('search').addEventListener('input', filterRestaurants);
            document.getElementById('cuisine-filter').addEventListener('change', filterRestaurants);
            document.getElementById('price-filter').addEventListener('change', filterRestaurants);
            document.getElementById('neighborhood-filter').addEventListener('change', filterRestaurants);
            document.getElementById('group-filter').addEventListener('change', filterRestaurants);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        }

        function populateFilters() {
            const cuisines = [...new Set(allRestaurants.map(r => r.cuisine_type))].sort();
            const neighborhoods = [...new Set(allRestaurants.flatMap(r => (r.tags || []).filter(t => t.includes('_') && !t.startsWith('group_') && !t.startsWith('chef_') && !t.includes('dining') && !t.includes('night'))))].sort();
            const groups = [...new Set(allRestaurants.flatMap(r => (r.tags || []).filter(t => t.startsWith('group_') || t.startsWith('chef_'))))].sort();

            const cuisineFilter = document.getElementById('cuisine-filter');
            cuisines.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                cuisineFilter.appendChild(opt);
            });

            const neighborhoodFilter = document.getElementById('neighborhood-filter');
            neighborhoods.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                opt.textContent = n.replace(/_/g, ' ');
                neighborhoodFilter.appendChild(opt);
            });

            const groupFilter = document.getElementById('group-filter');
            groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = formatGroupName(g);
                groupFilter.appendChild(opt);
            });
        }

        function formatGroupName(tag) {
            const cleaned = tag.replace(/^(group_|chef_)/, '');
            const formatted = cleaned.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            return tag.startsWith('chef_') ? 'Chef: ' + formatted : formatted;
        }

        function toggleFilter(type) {
            const btn = document.getElementById(type + '-filter');
            const isActive = btn.dataset.active === 'true';
            btn.dataset.active = !isActive;

            if (type === 'new') {
                btn.classList.toggle('active-new');
            } else if (type === 'coffee') {
                btn.classList.toggle('active-coffee');
            }

            filterRestaurants();
        }

        function clearFilters() {
            document.getElementById('search').value = '';
            document.getElementById('cuisine-filter').value = '';
            document.getElementById('price-filter').value = '';
            document.getElementById('neighborhood-filter').value = '';
            document.getElementById('group-filter').value = '';

            ['new', 'coffee'].forEach(type => {
                const btn = document.getElementById(type + '-filter');
                btn.dataset.active = 'false';
                btn.classList.remove('active-new', 'active-coffee');
            });

            filterRestaurants();
        }

        function filterRestaurants() {
            const search = document.getElementById('search').value.toLowerCase();
            const cuisine = document.getElementById('cuisine-filter').value;
            const price = document.getElementById('price-filter').value;
            const neighborhood = document.getElementById('neighborhood-filter').value;
            const group = document.getElementById('group-filter').value;
            const showNew = document.getElementById('new-filter').dataset.active === 'true';
            const showCoffee = document.getElementById('coffee-filter').dataset.active === 'true';

            filteredRestaurants = allRestaurants.filter(r => {
                if (search && !matchesSearch(r, search)) return false;
                if (cuisine && r.cuisine_type !== cuisine) return false;
                if (price && r.price_range !== price) return false;
                if (neighborhood && !(r.tags || []).includes(neighborhood)) return false;
                if (group && !(r.tags || []).includes(group)) return false;
                if (showNew && !isNewRestaurant(r)) return false;
                if (showCoffee && !r.cuisine_type.toLowerCase().includes('coffee') && !r.cuisine_type.toLowerCase().includes('cafe')) return false;
                return true;
            });

            applySorting();
            renderRestaurants();

            const hasFilters = search || cuisine || price || neighborhood || group || showNew || showCoffee;
            document.getElementById('clear-filters').classList.toggle('hidden', !hasFilters);
        }

        function matchesSearch(r, search) {
            return r.name.toLowerCase().includes(search) ||
                   r.cuisine_type.toLowerCase().includes(search) ||
                   (r.description || '').toLowerCase().includes(search) ||
                   (r.highlights || '').toLowerCase().includes(search) ||
                   (r.tags || []).some(t => t.toLowerCase().includes(search));
        }

        function isNewRestaurant(r) {
            if (!r.opening_date) return false;
            const openingDate = new Date(r.opening_date);
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            return openingDate > threeMonthsAgo;
        }

        function sortBy(column) {
            if (currentSort.column === column) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.order = 'asc';
            }
            applySorting();
            renderRestaurants();
        }

        function applySorting() {
            filteredRestaurants.sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                // Handle null/undefined
                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return 1;
                if (bVal == null) return -1;

                // Handle dates
                if (currentSort.column === 'opening_date') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                }

                // Handle strings
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return currentSort.order === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            ['name', 'cuisine_type', 'price_range', 'average_rating', 'date_night_score', 'atmosphere_score', 'opening_date'].forEach(col => {
                const elem = document.getElementById('sort-' + col);
                if (col === currentSort.column) {
                    elem.textContent = currentSort.order === 'asc' ? '↑' : '↓';
                } else {
                    elem.textContent = '';
                }
            });
        }

        function getPriceBadgeClass(price) {
            if (price === '$') return 'badge-price-1';
            if (price === '$$') return 'badge-price-2';
            if (price === '$$$') return 'badge-price-3';
            if (price === '$$$$') return 'badge-price-4';
            return 'badge-price-1';
        }

        function formatScore(score) {
            return score ? score.toFixed(1) : '-';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function renderRestaurants() {
            document.getElementById('stats').textContent = filteredRestaurants.length + ' restaurant' + (filteredRestaurants.length !== 1 ? 's' : '');

            const loading = document.getElementById('loading');
            const table = document.getElementById('restaurants-table');
            const tbody = document.getElementById('restaurants-tbody');

            loading.classList.add('hidden');

            if (filteredRestaurants.length === 0) {
                table.classList.add('hidden');
                return;
            }

            table.classList.remove('hidden');

            tbody.innerHTML = filteredRestaurants.map((r, index) => {
                const addressParts = r.address.split(',').slice(0, 2).join(',');
                const displayTags = (r.tags || []).filter(t => !t.startsWith('group_') && !t.startsWith('chef_')).slice(0, 3);

                return '<tr>' +
                    '<td>' +
                        '<div class="restaurant-name" onclick="showRestaurantByIndex(' + index + ')">' +
                            r.name +
                            (isNewRestaurant(r) ? ' <span class="badge badge-new">New</span>' : '') +
                        '</div>' +
                        (r.highlights ? '<div class="highlights">' + r.highlights + '</div>' : '') +
                    '</td>' +
                    '<td>' + r.cuisine_type + '</td>' +
                    '<td>' + addressParts + '</td>' +
                    '<td><span class="badge ' + getPriceBadgeClass(r.price_range) + '">' + r.price_range + '</span></td>' +
                    '<td><span class="score">' + formatScore(r.average_rating) + '</span></td>' +
                    '<td><span class="score">' + formatScore(r.date_night_score) + '</span></td>' +
                    '<td><span class="score">' + formatScore(r.atmosphere_score) + '</span></td>' +
                    '<td>' + formatDate(r.opening_date) + '</td>' +
                    '<td>' + displayTags.map(t => '<span class="tag">' + t.replace(/_/g, ' ') + '</span>').join(' ') + '</td>' +
                '</tr>';
            }).join('');
        }

        function showRestaurantByIndex(index) {
            const r = filteredRestaurants[index];
            if (!r) return;

            document.getElementById('modal-name').textContent = r.name;
            let meta = r.cuisine_type + ' · ' + r.price_range;
            if (r.average_rating) meta += ' · ' + r.average_rating.toFixed(1) + '/10';
            if (r.date_night_score) meta += ' · ' + r.date_night_score.toFixed(1) + ' date night';
            document.getElementById('modal-meta').textContent = meta;

            let body = '<div class="modal-section"><h3>Address</h3><p>' + r.address + '</p>';
            if (r.phone) body += '<p><a href="tel:' + r.phone + '">' + r.phone + '</a></p>';
            if (r.website) body += '<p><a href="' + r.website + '" target="_blank">Website →</a></p>';
            body += '</div>';

            if (r.description) body += '<div class="modal-section"><h3>Description</h3><p>' + r.description + '</p></div>';
            if (r.atmosphere) body += '<div class="modal-section"><h3>Atmosphere</h3><p>' + r.atmosphere + '</p></div>';
            if (r.special_features) body += '<div class="modal-section"><h3>Special Features</h3><p>' + r.special_features + '</p></div>';
            if (r.parking_info) body += '<div class="modal-section"><h3>Parking</h3><p>' + r.parking_info + '</p></div>';

            document.getElementById('modal-body').innerHTML = body;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Close modal when clicking outside content
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal' || e.target.classList.contains('modal-wrapper') || e.target.classList.contains('modal-grid')) {
                closeModal();
            }
        });

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
    </script>
</body>
</html>
